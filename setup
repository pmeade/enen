#!/bin/bash
# enen setup script
# Downloads and installs IntgrNN dependency

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
EXTERNAL_DIR="$SCRIPT_DIR/external"
INTGRNN_DIR="$EXTERNAL_DIR/intgr_nn"

# IntgrNN release configuration
INTGRNN_REPO="double-star-games/intgr_nn"
INTGRNN_VERSION="${INTGRNN_VERSION:-latest}"

echo "enen setup"
echo "=========="
echo

# Detect platform
detect_platform() {
    local os arch

    case "$(uname -s)" in
        Linux*)  os="linux" ;;
        Darwin*) os="macos" ;;
        MINGW*|MSYS*|CYGWIN*) os="windows" ;;
        *)
            echo "Unsupported OS: $(uname -s)"
            return 1
            ;;
    esac

    case "$(uname -m)" in
        x86_64|amd64) arch="x86_64" ;;
        aarch64|arm64) arch="arm64" ;;
        *)
            echo "Unsupported architecture: $(uname -m)"
            return 1
            ;;
    esac

    # Windows uses different naming
    if [ "$os" = "windows" ]; then
        arch="x64"
    fi

    echo "${os}-${arch}"
}

PLATFORM=$(detect_platform) || exit 1
echo "Detected platform: $PLATFORM"
echo

# Check if already installed (Windows uses .lib, Unix uses .a)
if [ -d "$INTGRNN_DIR/include" ]; then
    if [ -f "$INTGRNN_DIR/lib/libintgr_nn.a" ] || [ -f "$INTGRNN_DIR/lib/intgr_nn.lib" ]; then
        echo "IntgrNN already installed at $INTGRNN_DIR"
        echo "Remove external/intgr_nn to reinstall."
        exit 0
    fi
fi

mkdir -p "$EXTERNAL_DIR"

# Try to download from GitHub release
echo "Fetching IntgrNN..."

if command -v gh &> /dev/null; then
    echo "Using GitHub CLI to download release..."

    if [ "$INTGRNN_VERSION" = "latest" ]; then
        RELEASE_TAG=$(gh release view --repo "$INTGRNN_REPO" --json tagName -q .tagName 2>/dev/null || echo "")
    else
        RELEASE_TAG="$INTGRNN_VERSION"
    fi

    if [ -n "$RELEASE_TAG" ]; then
        echo "Downloading IntgrNN $RELEASE_TAG for $PLATFORM..."
        TEMP_DIR=$(mktemp -d)

        # Construct platform-specific pattern (Windows uses .zip, others use .tar.gz)
        if [[ "$PLATFORM" == windows-* ]]; then
            PATTERN="intgr_nn-${PLATFORM}.zip"
        else
            PATTERN="intgr_nn-${PLATFORM}.tar.gz"
        fi

        if gh release download "$RELEASE_TAG" --repo "$INTGRNN_REPO" --pattern "$PATTERN" --dir "$TEMP_DIR" 2>/dev/null; then
            ARCHIVE="$TEMP_DIR/$PATTERN"
            if [ -f "$ARCHIVE" ]; then
                echo "Extracting..."
                mkdir -p "$INTGRNN_DIR"
                if [[ "$PLATFORM" == windows-* ]]; then
                    # unzip may warn about backslashes in Windows-created zips; ignore warnings
                    unzip -q "$ARCHIVE" -d "$INTGRNN_DIR" || true
                else
                    tar -xzf "$ARCHIVE" -C "$INTGRNN_DIR"
                fi
                rm -rf "$TEMP_DIR"
                # Verify extraction succeeded
                if [ -d "$INTGRNN_DIR/include" ]; then
                    echo "IntgrNN installed successfully."
                    exit 0
                fi
            fi
        fi

        rm -rf "$TEMP_DIR"
        echo "No release found for platform: $PLATFORM"
    fi
fi

# Manual instructions if automatic download fails
echo
echo "ERROR: Could not automatically install IntgrNN."
echo
echo "IntgrNN is a separate library with its own license."
echo "To install manually:"
echo
echo "  1. Visit https://github.com/double-star-games/intgr_nn/releases"
if [[ "$PLATFORM" == windows-* ]]; then
    echo "  2. Download intgr_nn-${PLATFORM}.zip"
else
    echo "  2. Download intgr_nn-${PLATFORM}.tar.gz"
fi
echo "  3. Extract to external/intgr_nn/"
echo
echo "Required structure:"
echo "  external/intgr_nn/"
echo "    include/intgr_nn/intgr_nn.h"
if [[ "$PLATFORM" == windows-* ]]; then
    echo "    lib/intgr_nn.lib"
else
    echo "    lib/libintgr_nn.a"
fi
echo
exit 1
